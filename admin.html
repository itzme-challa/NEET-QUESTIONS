<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NEET Quiz Admin</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #4361ee;
      --primary-dark: #3a0ca3;
      --secondary-color: #4cc9f0;
      --success-color: #4ade80;
      --error-color: #f87171;
      --warning-color: #fbbf24;
      --text-dark: #1f2937;
      --text-medium: #6b7280;
      --text-light: #9ca3af;
      --bg-light: #f9fafb;
      --border-color: #e5e7eb;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: #f3f4f6;
      color: var(--text-dark);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    #app {
      max-width: 100%;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      background-color: white;
      padding: 1rem;
      box-shadow: var(--shadow-sm);
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 600;
      color: var(--primary-dark);
    }

    .logo-icon {
      font-size: 1.5rem;
      color: var(--primary-color);
    }

    .main-content {
      flex: 1;
      padding: 1.5rem;
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
    }

    .card {
      background-color: white;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      margin-bottom: 1.5rem;
    }

    .card-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-title {
      font-weight: 600;
      font-size: 1.25rem;
    }

    .card-body {
      padding: 1.5rem;
    }

    .btn {
      padding: 0.5rem 1rem;
      border-radius: var(--radius-sm);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      border: none;
    }

    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background-color: var(--primary-dark);
    }

    .btn-outline {
      background-color: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-medium);
    }

    .btn-outline:hover {
      background-color: var(--bg-light);
    }

    .btn-icon {
      padding: 0.5rem;
      border-radius: 50%;
      width: 2.5rem;
      height: 2.5rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .form-control {
      display: block;
      width: 100%;
      padding: 0.5rem 0.75rem;
      margin-bottom: 1rem;
      font-size: 1rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      background-color: white;
    }

    .alert {
      padding: 0.75rem 1.25rem;
      margin-bottom: 1rem;
      border: 1px solid transparent;
      border-radius: var(--radius-sm);
    }

    .alert-success {
      color: #166534;
      background-color: #dcfce7;
      border-color: #bbf7d0;
    }

    .alert-error {
      color: #991b1b;
      background-color: #fee2e2;
      border-color: #fecaca;
    }

    .progress {
      height: 0.75rem;
      background-color: var(--bg-light);
      border-radius: var(--radius-sm);
      margin-bottom: 1.5rem;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background-color: var(--primary-color);
      transition: width 0.3s ease;
      font-size: 0.65rem;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-weight: 500;
    }

    .badge-primary {
      background-color: #e0e7ff;
      color: var(--primary-dark);
    }

    .badge-success {
      background-color: #dcfce7;
      color: #166534;
    }

    .group-container {
      margin-top: 1.5rem;
    }

    .group-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      font-weight: 600;
    }

    .group-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 0.75rem;
    }

    .group-item {
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      background-color: white;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .group-item:hover {
      background-color: var(--bg-light);
    }

    .group-item.selected {
      background-color: #e0e7ff;
      border-color: var(--primary-color);
    }

    .group-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.25rem;
    }

    .group-item-count {
      font-size: 0.75rem;
      color: var(--text-medium);
    }

    .hierarchy-path {
      font-size: 0.875rem;
      color: var(--text-medium);
      margin-bottom: 1rem;
      padding: 0.75rem;
      background-color: var(--bg-light);
      border-radius: var(--radius-sm);
    }

    .hierarchy-path span {
      color: var(--primary-color);
      font-weight: 500;
    }

    .backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal {
      background-color: white;
      border-radius: var(--radius-md);
      width: 90%;
      max-width: 500px;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .loading {
      padding: 2rem;
      text-align: center;
    }

    .spinner {
      width: 2rem;
      height: 2rem;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .group-list {
        grid-template-columns: 1fr;
      }
      
      .main-content {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <header class="header">
      <div class="logo">
        <i class="fas fa-atom logo-icon"></i>
        <span>NEET Quiz Admin</span>
      </div>
    </header>

    <main class="main-content">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Question Importer</h2>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label for="subjectSelect">Select Subject:</label>
            <select id="subjectSelect" class="form-control">
              <option value="biology">Biology</option>
              <option value="chemistry">Chemistry</option>
              <option value="physics">Physics</option>
            </select>
          </div>
          <button id="fetchBtn" class="btn btn-primary">
            <i class="fas fa-download"></i> Fetch Questions
          </button>
        </div>
      </div>

      <div class="card" id="previewCard" style="display: none;">
        <div class="card-header">
          <h2 class="card-title">Organize Questions</h2>
          <div id="questionStats" class="badge badge-primary">0 questions</div>
        </div>
        <div class="card-body">
          <div id="previewContent"></div>
          
          <div id="groupSelection" style="display: none;">
            <div class="group-container">
              <div class="group-header">
                <i class="fas fa-layer-group"></i>
                <span>Hierarchy Groups</span>
              </div>
              <div class="hierarchy-path">
                Database path: <span>subjects</span> → <span id="currentSubjectPath"></span> → <span>chapters</span> → <span>units</span> → <span>topics</span> → <span>questions</span>
              </div>
              
              <div class="group-list" id="chapterList"></div>
              
              <div class="group-list" id="unitList" style="display: none; margin-top: 1.5rem;"></div>
              
              <div class="group-list" id="topicList" style="display: none; margin-top: 1.5rem;"></div>
            </div>
            
            <div style="margin-top: 1.5rem;">
              <div class="group-header">
                <i class="fas fa-check-circle"></i>
                <span>Selected Groups</span>
                <span id="selectedGroupsCount" class="badge">0 selected</span>
              </div>
              <div id="selectedGroupsList" style="margin-top: 0.5rem;"></div>
              
              <div class="selection-actions" style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                <button id="selectAllBtn" class="btn btn-outline">Select All</button>
                <button id="deselectAllBtn" class="btn btn-outline">Clear Selection</button>
              </div>
            </div>
          </div>
          
          <div class="progress" id="progressContainer" style="display: none;">
            <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%">0%</div>
          </div>
          
          <button id="submitBtn" class="btn btn-primary" style="margin-top: 1.5rem; display: none;">
            <i class="fas fa-save"></i> Submit to Database
          </button>
        </div>
      </div>

      <div class="card" id="statusCard" style="display: none;">
        <div class="card-header">
          <h2 class="card-title">Submission Results</h2>
        </div>
        <div class="card-body" id="statusContent"></div>
      </div>
    </main>

    <div class="backdrop" id="loadingModal">
      <div class="modal">
        <div class="loading">
          <div class="spinner"></div>
          <div id="loadingText">Processing...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD54FxWUlPn03bxD0UnD0oxVcMkI9ovCeQ",
      authDomain: "community-604af.firebaseapp.com",
      databaseURL: "https://community-604af-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "community-604af",
      storageBucket: "community-604af.appspot.com",
      messagingSenderId: "735063146170",
      appId: "1:735063146170:web:725bce2c3c64afc0f30c83",
      measurementId: "G-7YD8RLH33Q"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // DOM Elements
    const elements = {
      subjectSelect: document.getElementById('subjectSelect'),
      fetchBtn: document.getElementById('fetchBtn'),
      previewCard: document.getElementById('previewCard'),
      previewContent: document.getElementById('previewContent'),
      questionStats: document.getElementById('questionStats'),
      groupSelection: document.getElementById('groupSelection'),
      chapterList: document.getElementById('chapterList'),
      unitList: document.getElementById('unitList'),
      topicList: document.getElementById('topicList'),
      currentSubjectPath: document.getElementById('currentSubjectPath'),
      selectedGroupsCount: document.getElementById('selectedGroupsCount'),
      selectedGroupsList: document.getElementById('selectedGroupsList'),
      selectAllBtn: document.getElementById('selectAllBtn'),
      deselectAllBtn: document.getElementById('deselectAllBtn'),
      submitBtn: document.getElementById('submitBtn'),
      statusCard: document.getElementById('statusCard'),
      statusContent: document.getElementById('statusContent'),
      loadingModal: document.getElementById('loadingModal'),
      loadingText: document.getElementById('loadingText'),
      progressContainer: document.getElementById('progressContainer'),
      progressBar: document.getElementById('progressBar')
    };

    // Configuration
    const subjectUrls = {
      biology: 'https://eduhub-kmr.pages.dev/data/biology.json',
      chemistry: 'https://eduhub-kmr.pages.dev/data/chemistry.json',
      physics: 'https://eduhub-kmr.pages.dev/data/physics.json'
    };
    const BATCH_SIZE = 50;

    // App State
    let state = {
      fetchedQuestions: [],
      groupedQuestions: {
        chapters: {},
        units: {},
        topics: {}
      },
      selectedGroups: new Set(),
      subject: null
    };

    // Helper Functions
    function showLoading(show, text = 'Processing...') {
      elements.loadingModal.style.display = show ? 'flex' : 'none';
      elements.loadingText.textContent = text;
    }

    function updateProgress(percent) {
      elements.progressBar.style.width = `${percent}%`;
      elements.progressBar.textContent = `${Math.round(percent)}%`;
    }

    function createSlug(name) {
      return name.toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/(^-|-$)/g, '');
    }

    function getChapterName(question) {
      return question['Chapter Name'] || question['chapter name'] || 
             question['Unique Chapter Name'] || 
             question.topic_name?.split('>>')[0]?.trim() || 'Uncategorized';
    }

    function getUnitName(question) {
      return question.topic_name?.split('>>')[1]?.trim() || 'Uncategorized';
    }

    function getTopicName(question) {
      return question.topic_name?.split('>>')[2]?.trim() || 'Uncategorized';
    }

    function formatQuestion(question, subject) {
      return {
        subject: subject,
        question: question.question,
        answer: question.answer,
        explanation: question.explanation,
        quiz_type: question.quiz_type || 'mcq',
        chapter: getChapterName(question),
        unit: getUnitName(question),
        topic: getTopicName(question),
        topic_name: `${getChapterName(question)}>>${getUnitName(question)}>>${getTopicName(question)}`,
        ...(question.quiz_type === 'mcq' && {
          option_a: question.option_a,
          option_b: question.option_b,
          option_c: question.option_c,
          option_d: question.option_d
        }),
        ...(question.quiz_type === 'match' && {
          option_a: question.option_a,
          option_b: question.option_b,
          option_c: question.option_c,
          option_d: question.option_d
        }),
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
      };
    }

    function groupQuestions(questions, subject) {
      const groups = {
        chapters: {},
        units: {},
        topics: {}
      };

      questions.forEach(q => {
        const formatted = formatQuestion(q, subject);
        const chapter = formatted.chapter;
        const unit = `${chapter}>>${formatted.unit}`;
        const topic = `${unit}>>${formatted.topic}`;

        // Group by chapter
        if (!groups.chapters[chapter]) {
          groups.chapters[chapter] = {
            name: chapter,
            slug: createSlug(chapter),
            questions: [],
            units: new Set()
          };
        }
        groups.chapters[chapter].questions.push(formatted);
        groups.chapters[chapter].units.add(formatted.unit);

        // Group by unit
        if (!groups.units[unit]) {
          groups.units[unit] = {
            name: formatted.unit,
            slug: createSlug(formatted.unit),
            chapter: chapter,
            chapterSlug: createSlug(chapter),
            questions: [],
            topics: new Set()
          };
        }
        groups.units[unit].questions.push(formatted);
        groups.units[unit].topics.add(formatted.topic);

        // Group by topic
        if (!groups.topics[topic]) {
          groups.topics[topic] = {
            name: formatted.topic,
            slug: createSlug(formatted.topic),
            chapter: chapter,
            chapterSlug: createSlug(chapter),
            unit: formatted.unit,
            unitSlug: createSlug(formatted.unit),
            questions: []
          };
        }
        groups.topics[topic].questions.push(formatted);
      });

      return groups;
    }

    function renderGroupItems(groups, type) {
      const container = type === 'chapters' ? elements.chapterList :
                        type === 'units' ? elements.unitList :
                        elements.topicList;
      
      container.innerHTML = '';
      
      Object.entries(groups[type]).forEach(([key, group]) => {
        const item = document.createElement('div');
        item.className = `group-item ${state.selectedGroups.has(`${type}:${key}`) ? 'selected' : ''}`;
        item.dataset.type = type;
        item.dataset.key = key;
        
        item.innerHTML = `
          <div class="group-item-header">
            <div>${group.name}</div>
            <span class="badge ${state.selectedGroups.has(`${type}:${key}`) ? 'badge-primary' : ''}">
              ${group.questions.length} Qs
            </span>
          </div>
          <div class="group-item-count">
            ${type === 'chapters' ? `${group.units.size} units` : 
             type === 'units' ? `${group.topics.size} topics` : 
             'Questions'}
          </div>
        `;
        
        item.addEventListener('click', () => toggleGroupSelection(type, key, item));
        container.appendChild(item);
      });
      
      container.style.display = 'grid';
    }

    function toggleGroupSelection(type, key, element) {
      const groupKey = `${type}:${key}`;
      
      if (state.selectedGroups.has(groupKey)) {
        state.selectedGroups.delete(groupKey);
        element.classList.remove('selected');
        element.querySelector('.badge').classList.remove('badge-primary');
      } else {
        state.selectedGroups.add(groupKey);
        element.classList.add('selected');
        element.querySelector('.badge').classList.add('badge-primary');
      }
      
      updateSelectionUI();
    }

    function updateSelectionUI() {
      elements.selectedGroupsCount.textContent = `${state.selectedGroups.size} selected`;
      
      elements.selectedGroupsList.innerHTML = '';
      state.selectedGroups.forEach(groupKey => {
        const [type, key] = groupKey.split(':');
        const group = state.groupedQuestions[type][key];
        
        const item = document.createElement('div');
        item.className = 'badge';
        item.style.marginRight = '0.5rem';
        item.style.marginBottom = '0.5rem';
        item.style.display = 'inline-block';
        
        let icon = '';
        if (type === 'chapters') icon = '<i class="fas fa-book"></i>';
        else if (type === 'units') icon = '<i class="fas fa-layer-group"></i>';
        else icon = '<i class="fas fa-tag"></i>';
        
        item.innerHTML = `${icon} ${group.name} (${group.questions.length} Qs)`;
        elements.selectedGroupsList.appendChild(item);
      });
      
      elements.submitBtn.style.display = state.selectedGroups.size > 0 ? 'block' : 'none';
    }

    function getSelectedQuestions() {
      const questions = [];
      
      state.selectedGroups.forEach(groupKey => {
        const [type, key] = groupKey.split(':');
        const group = state.groupedQuestions[type][key];
        if (group) {
          questions.push(...group.questions);
        }
      });
      
      return questions;
    }

    // Main Functions
    async function fetchQuestions() {
      state.subject = elements.subjectSelect.value;
      showLoading(true, `Fetching ${state.subject} questions...`);
      
      try {
        const response = await fetch(subjectUrls[state.subject]);
        if (!response.ok) throw new Error('Failed to fetch questions');
        const data = await response.json();
        
        state.fetchedQuestions = data;
        state.groupedQuestions = groupQuestions(data, state.subject);
        state.selectedGroups = new Set();
        
        elements.questionStats.textContent = `${data.length} questions`;
        elements.currentSubjectPath.textContent = state.subject;
        
        elements.previewContent.innerHTML = `
          <p>Successfully fetched ${data.length} questions organized into:</p>
          <ul>
            <li>${Object.keys(state.groupedQuestions.chapters).length} Chapters</li>
            <li>${Object.keys(state.groupedQuestions.units).length} Units</li>
            <li>${Object.keys(state.groupedQuestions.topics).length} Topics</li>
          </ul>
        `;
        
        renderGroupItems(state.groupedQuestions, 'chapters');
        renderGroupItems(state.groupedQuestions, 'units');
        renderGroupItems(state.groupedQuestions, 'topics');
        
        elements.groupSelection.style.display = 'block';
        elements.previewCard.style.display = 'block';
        elements.statusCard.style.display = 'none';
        elements.progressContainer.style.display = 'none';
        
        updateSelectionUI();
        
      } catch (error) {
        console.error('Error fetching questions:', error);
        alert(`Failed to fetch questions: ${error.message}`);
      } finally {
        showLoading(false);
      }
    }

    async function submitQuestions() {
      const questionsToSubmit = getSelectedQuestions();
      if (questionsToSubmit.length === 0) {
        alert('No questions selected for submission');
        return;
      }
      
      showLoading(true, 'Preparing database structure...');
      elements.progressContainer.style.display = 'block';
      updateProgress(0);
      
      try {
        let successfulSubmissions = 0;
        let failedSubmissions = 0;
        const totalQuestions = questionsToSubmit.length;
        const subjectSlug = createSlug(state.subject);
        
        // Track created nodes to avoid duplicates
        const createdNodes = {
          subjects: new Set(),
          chapters: new Set(),
          units: new Set(),
          topics: new Set()
        };
        
        // Process in batches
        for (let i = 0; i < totalQuestions; i += BATCH_SIZE) {
          const batchEnd = Math.min(i + BATCH_SIZE, totalQuestions);
          const batch = questionsToSubmit.slice(i, batchEnd);
          
          showLoading(true, `Submitting questions ${i+1}-${batchEnd} of ${totalQuestions}...`);
          
          try {
            for (const question of batch) {
              try {
                const chapterSlug = createSlug(question.chapter);
                const unitSlug = createSlug(question.unit);
                const topicSlug = createSlug(question.topic);
                
                // 1. Ensure subject exists
                const subjectKey = `subjects/${subjectSlug}`;
                if (!createdNodes.subjects.has(subjectKey)) {
                  await db.ref(subjectKey).set({
                    name: state.subject,
                    slug: subjectSlug,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                  });
                  createdNodes.subjects.add(subjectKey);
                }
                
                // 2. Ensure chapter exists
                const chapterKey = `${subjectKey}/chapters/${chapterSlug}`;
                if (!createdNodes.chapters.has(chapterKey)) {
                  await db.ref(chapterKey).set({
                    name: question.chapter,
                    slug: chapterSlug,
                    subject: state.subject,
                    subjectSlug: subjectSlug,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                  });
                  createdNodes.chapters.add(chapterKey);
                }
                
                // 3. Ensure unit exists
                const unitKey = `${chapterKey}/units/${unitSlug}`;
                if (!createdNodes.units.has(unitKey)) {
                  await db.ref(unitKey).set({
                    name: question.unit,
                    slug: unitSlug,
                    chapter: question.chapter,
                    chapterSlug: chapterSlug,
                    subject: state.subject,
                    subjectSlug: subjectSlug,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                  });
                  createdNodes.units.add(unitKey);
                }
                
                // 4. Ensure topic exists
                const topicKey = `${unitKey}/topics/${topicSlug}`;
                if (!createdNodes.topics.has(topicKey)) {
                  await db.ref(topicKey).set({
                    name: question.topic,
                    slug: topicSlug,
                    unit: question.unit,
                    unitSlug: unitSlug,
                    chapter: question.chapter,
                    chapterSlug: chapterSlug,
                    subject: state.subject,
                    subjectSlug: subjectSlug,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                  });
                  createdNodes.topics.add(topicKey);
                }
                
                // 5. Add question
                const questionRef = db.ref(`${topicKey}/questions`).push();
                await questionRef.set(question);
                
                successfulSubmissions++;
                
              } catch (error) {
                console.error('Error submitting question:', question.question, error);
                failedSubmissions++;
              }
            }
            
            // Update progress
            updateProgress((batchEnd / totalQuestions) * 100);
          } catch (error) {
            console.error('Error submitting batch:', error);
            failedSubmissions += batch.length;
          }
        }
        
        // Show results
        showLoading(false);
        elements.statusContent.innerHTML = `
          <div class="alert alert-success">
            <i class="fas fa-check-circle"></i> Successfully submitted ${successfulSubmissions} questions!
          </div>
          
          <div class="hierarchy-path">
            Created database structure: <br>
            <span>subjects</span> → 
            <span>${state.subject}</span> → 
            <span>chapters</span> → 
            <span>units</span> → 
            <span>topics</span> → 
            <span>questions</span>
          </div>
          
          <h3 style="margin-top: 1rem;">Submission Details:</h3>
          <ul>
            <li>Subjects created: ${createdNodes.subjects.size}</li>
            <li>Chapters created: ${createdNodes.chapters.size}</li>
            <li>Units created: ${createdNodes.units.size}</li>
            <li>Topics created: ${createdNodes.topics.size}</li>
          </ul>
          
          ${failedSubmissions > 0 ? `
            <div class="alert alert-error" style="margin-top: 1rem;">
              <i class="fas fa-exclamation-circle"></i> 
              ${failedSubmissions} questions failed to submit (check console for details)
            </div>
          ` : ''}
        `;
        
        elements.statusCard.style.display = 'block';
        elements.previewCard.style.display = 'none';
        
      } catch (error) {
        console.error('Submission error:', error);
        elements.statusContent.innerHTML = `
          <div class="alert alert-error">
            <i class="fas fa-exclamation-circle"></i> 
            Error during submission: ${error.message}
          </div>
        `;
        elements.statusCard.style.display = 'block';
      } finally {
        showLoading(false);
      }
    }

    // Event Listeners
    elements.fetchBtn.addEventListener('click', fetchQuestions);
    elements.submitBtn.addEventListener('click', submitQuestions);
    
    elements.selectAllBtn.addEventListener('click', () => {
      Object.keys(state.groupedQuestions.chapters).forEach(key => {
        state.selectedGroups.add(`chapters:${key}`);
      });
      Object.keys(state.groupedQuestions.units).forEach(key => {
        state.selectedGroups.add(`units:${key}`);
      });
      Object.keys(state.groupedQuestions.topics).forEach(key => {
        state.selectedGroups.add(`topics:${key}`);
      });
      
      document.querySelectorAll('.group-item').forEach(item => {
        item.classList.add('selected');
        item.querySelector('.badge').classList.add('badge-primary');
      });
      
      updateSelectionUI();
    });
    
    elements.deselectAllBtn.addEventListener('click', () => {
      state.selectedGroups.clear();
      document.querySelectorAll('.group-item').forEach(item => {
        item.classList.remove('selected');
        item.querySelector('.badge').classList.remove('badge-primary');
      });
      updateSelectionUI();
    });
  </script>
</body>
</html>
